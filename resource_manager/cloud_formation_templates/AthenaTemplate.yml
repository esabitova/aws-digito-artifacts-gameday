#
# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of this
# software and associated documentation files (the "Software"), to deal in the Software
# without restriction, including without limitation the rights to use, copy, modify,
# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#
---
AWSTemplateFormatVersion: 2010-09-09
Description: Test stack for Athena and related resources. Contains all alarms
Outputs:
  AthenaWorkGroup:
    Description: Athena WorkGroup name
    Value: !Ref  AthenaWorkGroup
  #  AthenaDataCatalog:
  #    Description: Athena DataCatalog name
  #    Value: !Ref  AthenaDataCatalog
  TotalExecutionTimeAlarm:
    Description: Alarm
    Value: !Ref  TotalExecutionTimeAlarm
  TotalExecutionTimeQueryStateFailedAlarm:
    Description: Alarm
    Value: !Ref  TotalExecutionTimeQueryStateFailedAlarm
  S3Bucket:
    Description: S3 Bucket Name
    Value: !Ref S3Bucket
  GlueDataBase:
    Description: Glue DataBase Name
    Value: !Ref GlueDataBase

Parameters:
  # what kind of parameters could be? Names for resources?

  #  TableName:
  #    Type: String
  #    Default: cfn-manual-table-flights-1

  DatabaseName:
    Type: String
    Description: Database name
    Default: athena-test-database


Resources:
  AthenaWorkGroup:
    Type: 'AWS::Athena::WorkGroup'
#    DependsOn: S3Bucket
    Properties:
      Description: Test WorkGroup for Athena
      Name: "athena-digito-workgroup"
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        PublishCloudWatchMetricsEnabled: true
        ResultConfiguration:
          OutputLocation: !Join [ "", [ "s3://" , Ref: S3Bucket, "/" ] ]

  #  AthenaDataCatalog:
  #    Type: 'AWS::Athena::DataCatalog'
  #    Properties:
  #      Description: Test DataCatalog for Athena
  #      Name: "athena-digito-datacatalog"
  #      Parameters:
  #        catalog-id: !Ref AWS::AccountId
  #      Type: GLUE

  GlueDataBase:
    Type: 'AWS::Glue::Database'
    #    DependsOn: AthenaDataCatalog
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput:
        Description: Test database for Athena service
        Name: !Ref 'DatabaseName'


  GlueCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Configuration: "{\"Version\":1.0,\"CrawlerOutput\":{\"Partitions\":{\"AddOrUpdateBehavior\":\"InheritFromTable\"},\"Tables\":{\"AddOrUpdateBehavior\":\"MergeNewColumns\"}}}"
      DatabaseName: "athena-test-database"
      Description: AWS Glue crawler to crawl flights data
      Name: 'cfn-crawler'
      Role: !GetAtt GlueRole.Arn
      SchemaChangePolicy:
        UpdateBehavior: "UPDATE_IN_DATABASE"
        DeleteBehavior: "LOG"
      TablePrefix: 'cfn_table_1_'
      Targets:
        S3Targets:
          # Public S3 bucket with the flights data
          # Make S3 bucket for csv file. Then upload this file with code?
          - Path: "s3://crawler-public-us-east-1/flight/2016/csv"

  GlueRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "glue.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName: "root"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action: "*"
                Resource: "*"

  #  AthenaPolicy:
  #    Type: AWS::IAM::Policy
  #    Properties:
  #      PolicyName: AmazonAthenaAccess
  #      PolicyDocument:
  #        Version: 2012-10-17
  #        Statement:
  ##          - Effect: Allow
  ##            Resource: "*"
  ##            Action:
  ##              athena:*
  ##          - Effect: Allow
  ##            Resource: "*"
  ##            Action:
  ##              - glue:CreateDatabase
  ##              - glue:DeleteDatabase
  ##              - glue:GetDatabase
  ##              - glue:CreateTable
  ##              - glue:DeleteTable
  ##              - glue:UpdateTable
  ##          - Effect: Allow
  ##            Resource: "arn:aws:s3:*"
  ##            Action:
  ##              - s3:GetBucketLocation
  ##              - s3:CreateBucket
  ##              - s3:PutObject
  ##              - s3:GetObject
  ##          - Effect: Allow
  ##            Resource: "*"
  ##            Action:
  ##              - cloudwatch:PutMetricAlarm
  ##              - cloudwatch:DescribeAlarms
  ##              - cloudwatch:DeleteAlarms
  #          - Effect: Allow
  #            Resource: "arn:aws:athena:eu-south-1:435978235099:workgroup/primary"
  #            Action:
  #              - athena:UpdateWorkGroup
  #              - athena:GetWorkGroup


  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Join
        - "-"
        - - "s3-athena-tests-bucket"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split
                  - "/"
                  - !Ref "AWS::StackId"
      AccessControl: Private

  TotalExecutionTimeAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "athena:alarm:total_execution_time:2020-04-01"
#      AlarmName: TotalExecutionTimeAlarm
      ActionsEnabled: false
      MetricName: "TotalExecutionTime"
      Namespace: "AWS/Athena"
      Statistic: "Maximum"
      Dimensions:
        - Name: WorkGroup
          Value: !Ref "AthenaWorkGroup"
        #        - Name: WorkGroup
        #          Value: !Ref "AthenaUpdateWorkGroup"
        - Name: QueryState
          Value: SUCCEEDED
        - Name: QueryType
          Value: DML
      Period: 60
      EvaluationPeriods: 5
      DatapointsToAlarm: 1
      Threshold: 29
      ComparisonOperator: "GreaterThanThreshold"
      TreatMissingData: "breaching"


  TotalExecutionTimeQueryStateFailedAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "athena:alarm:total_execution_time_failed:2020-04-01"
#      AlarmName: TotalExecutionTime_QueryState_Failed
      ActionsEnabled: false
      MetricName: "TotalExecutionTime"
      Namespace: "AWS/Athena"
      Statistic: "SampleCount"
      Dimensions:
        - Name: WorkGroup
          Value: !Ref "AthenaWorkGroup"
        #        - Name: WorkGroup
        #          Value: !Ref "AthenaUpdateWorkGroup"
        - Name: QueryState
          Value: FAILED
        - Name: QueryType
          Value: DML
      Period: 60
      EvaluationPeriods: 5
      DatapointsToAlarm: 1
      Threshold: 0
      ComparisonOperator: "GreaterThanThreshold"
      TreatMissingData: "breaching"